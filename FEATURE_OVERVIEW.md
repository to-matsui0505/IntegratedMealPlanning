# カメラ撮影による食材登録機能 - 機能概要

## 機能フロー図

```
┌─────────────────────────────────────────────────────────────────┐
│                     ユーザー操作フロー                              │
└─────────────────────────────────────────────────────────────────┘

   START: 食材登録ボタン押下
      ↓
┌──────────────────────────┐
│   入力方法選択画面        │
│  (InputScreen)           │
│                          │
│  📷 方法① カメラ撮影      │  ← ユーザーが選択
│  🧾 方法② レシート撮影    │
│  ✍️ 方法③ 手入力         │
└──────────────────────────┘
      ↓
┌──────────────────────────────────────────────────────────────┐
│               カメラ撮影画面 (InputCameraScreen)                 │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  ステップ1: 撮影                                                │
│  ┌─────────────────────────┐                                  │
│  │  [📷 撮影する]           │ ← ユーザーがタップ                │
│  │                         │                                  │
│  │  食材を撮影してAIで      │                                  │
│  │  自動認識します          │                                  │
│  └─────────────────────────┘                                  │
│           ↓                                                    │
│     カメラ起動 (CameraDevice)                                   │
│           ↓                                                    │
│     画像取得: /tmp/images/camera_123.jpg                        │
│           ↓                                                    │
│     一時保存 (ImageTempStore)                                   │
│       - imageId: img_1234567890                               │
│       - userId: user1                                         │
│       - filePath: /tmp/images/camera_123.jpg                  │
│                                                                │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  ステップ2: AI解析                                              │
│  ┌─────────────────────────┐                                  │
│  │  [解析中...]             │                                  │
│  │   🔄                     │                                  │
│  └─────────────────────────┘                                  │
│           ↓                                                    │
│     AnalyzeImageUseCase                                        │
│           ↓                                                    │
│     AIImageAnalyzer (Azure OpenAI)                             │
│           ↓                                                    │
│     解析結果 (JSON):                                            │
│       {                                                        │
│         "items": [                                             │
│           {                                                    │
│             "category": "野菜類",                               │
│             "subCategory": "葉物",                             │
│             "name": "ほうれん草",                               │
│             "quantity": 1.5,                                   │
│             "unit": "束",                                      │
│             "confidence": 0.87                                 │
│           }                                                    │
│         ]                                                      │
│       }                                                        │
│                                                                │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  ステップ3: 確認・編集                                           │
│  ┌────────────────────────────────────────────┐                │
│  │  認識された食材                              │                │
│  │                                             │                │
│  │  ┌───────────────────────────────┐          │                │
│  │  │ 大分類: [野菜類 ▼]               │          │                │
│  │  │ 小分類: [葉物 ▼]                 │          │                │
│  │  │ 名称:   ほうれん草                │          │                │
│  │  │ 数量:   1.5  単位: [束 ▼]        │          │                │
│  │  │                 [削除]           │          │                │
│  │  └───────────────────────────────┘          │                │
│  │                                             │                │
│  │  ┌───────────────────────────────┐          │                │
│  │  │ 大分類: [肉類 ▼]                 │          │                │
│  │  │ 小分類: [鶏肉 ▼]                 │          │                │
│  │  │ 名称:   鶏むね肉                  │          │                │
│  │  │ 数量:   300  単位: [g ▼]         │          │                │
│  │  │                 [削除]           │          │                │
│  │  └───────────────────────────────┘          │                │
│  │                                             │                │
│  │  [確定して保存]                              │ ← ユーザーがタップ │
│  └────────────────────────────────────────────┘                │
│                                                                │
├──────────────────────────────────────────────────────────────┤
│                                                                │
│  ステップ4: 保存                                                │
│           ↓                                                    │
│     AddItemUseCase.execute() × N                               │
│           ↓                                                    │
│     FridgeRepository.save() × N                                │
│           ↓                                                    │
│     SQLite保存:                                                │
│       - id: uuid                                               │
│       - type: 入庫                                             │
│       - category: 野菜類                                        │
│       - source: CAMERA                                         │
│       - sourceImageId: img_1234567890                          │
│       - updatedAt: 2025-10-13T11:30:00Z                       │
│           ↓                                                    │
│     一時画像削除 (ImageTempStore.deleteImage)                   │
│           ↓                                                    │
│  ┌─────────────────────────┐                                  │
│  │  保存完了                │                                  │
│  │  食材を登録しました       │                                  │
│  │                         │                                  │
│  │  [続けて入力]  [ダッシュボードへ]                              │
│  └─────────────────────────┘                                  │
│      ↓               ↓                                         │
│   (再撮影)      (完了・画面遷移)                                │
│                                                                │
└──────────────────────────────────────────────────────────────┘
```

## UI画面イメージ

### 1. 入力方法選択画面
```
┌─────────────────────────────┐
│ ← 戻る    食材登録            │
├─────────────────────────────┤
│                             │
│  登録方法を選択してください   │
│                             │
│  ┌───────────────────────┐  │
│  │  📷                   │  │
│  │  方法① カメラ撮影      │  │
│  │  食材を撮影してAIで     │  │
│  │  自動認識              │  │
│  └───────────────────────┘  │
│                             │
│  ┌───────────────────────┐  │
│  │  🧾                   │  │
│  │  方法② レシート撮影    │  │
│  │  準備中               │  │
│  └───────────────────────┘  │
│                             │
│  ┌───────────────────────┐  │
│  │  ✍️                   │  │
│  │  方法③ 手入力          │  │
│  │  準備中               │  │
│  └───────────────────────┘  │
│                             │
└─────────────────────────────┘
```

### 2. カメラ撮影画面（撮影前）
```
┌─────────────────────────────┐
│ 食材撮影           ✕ 戻る    │
├─────────────────────────────┤
│                             │
│                             │
│                             │
│      ┌─────────────┐         │
│      │ 📷 撮影する  │         │
│      └─────────────┘         │
│                             │
│   食材を撮影してAIで          │
│   自動認識します              │
│                             │
│                             │
│                             │
└─────────────────────────────┘
```

### 3. カメラ撮影画面（解析中）
```
┌─────────────────────────────┐
│ 食材撮影           ✕ 戻る    │
├─────────────────────────────┤
│                             │
│  ┌─────────────────────┐    │
│  │                     │    │
│  │   [撮影画像]        │    │
│  │                     │    │
│  └─────────────────────┘    │
│      [再撮影]                │
│                             │
│                             │
│         🔄                  │
│      解析中...               │
│                             │
│                             │
└─────────────────────────────┘
```

### 4. カメラ撮影画面（編集）
```
┌─────────────────────────────┐
│ 食材撮影           ✕ 戻る    │
├─────────────────────────────┤
│                             │
│  ┌─────────────────────┐    │
│  │   [撮影画像]        │    │
│  └─────────────────────┘    │
│      [再撮影]                │
│                             │
│  認識された食材              │
│  ┌─────────────────────┐    │
│  │ 大分類: 野菜類 ▼    │    │
│  │ 小分類: 葉物 ▼      │    │
│  │ 名称: ほうれん草     │    │
│  │ 数量: 1.5 束 ▼      │    │
│  │         [削除]       │    │
│  └─────────────────────┘    │
│                             │
│  ┌─────────────────────┐    │
│  │ 大分類: 肉類 ▼      │    │
│  │ 小分類: 鶏肉 ▼      │    │
│  │ 名称: 鶏むね肉       │    │
│  │ 数量: 300 g ▼       │    │
│  │         [削除]       │    │
│  └─────────────────────┘    │
│                             │
│    ┌─────────────────┐      │
│    │ 確定して保存     │      │
│    └─────────────────┘      │
│                             │
└─────────────────────────────┘
```

### 5. 保存完了ダイアログ
```
┌─────────────────────────────┐
│                             │
│   ┌───────────────────┐     │
│   │  保存完了          │     │
│   │  食材を登録しました │     │
│   │                   │     │
│   │  ┌─────────────┐  │     │
│   │  │ 続けて入力   │  │     │
│   │  └─────────────┘  │     │
│   │  ┌─────────────┐  │     │
│   │  │ダッシュボードへ│  │     │
│   │  └─────────────┘  │     │
│   └───────────────────┘     │
│                             │
└─────────────────────────────┘
```

## 技術仕様

### 対応分類
**大分類（12種類）**
- 野菜類、肉類、魚介類、乳製品、調味料、飲料
- 果物、穀類、卵、豆類、加工食品、その他

**小分類（動的）**
- 野菜類: 葉物、根菜、きのこ類、その他
- 肉類: 牛肉、豚肉、鶏肉、ひき肉、その他
- 魚介類: 魚、貝類、海藻、その他
- （他の大分類にも対応）

**単位（14種類）**
- g、kg、ml、L、個、本、枚、束
- パック、袋、缶、瓶、箱、その他

### データ構造
```typescript
interface FridgeItem {
  id: string;                    // UUID
  type: FridgeItemType;          // '入庫' | '出庫'
  category: string;              // 大分類
  subCategory: string;           // 小分類
  name: string;                  // 名称
  quantity: number;              // 数量
  unit: string;                  // 単位
  source?: FridgeItemSource;     // 'CAMERA' | 'RECEIPT' | 'MANUAL'
  sourceImageId?: string;        // 元画像のID
  updatedAt: Date;               // 更新日時
}
```

### AI解析結果
```typescript
interface AIAnalysisResult {
  imageId: string;
  items: Array<{
    category: string;            // 大分類
    subCategory: string;         // 小分類
    name: string;                // 名称
    quantity: number;            // 数量
    unit: string;                // 単位
    confidence: number;          // 信頼度 (0.0-1.0)
  }>;
  warnings?: string[];           // 警告メッセージ
}
```

## エラーハンドリング

### 1. カメラ権限エラー
```
┌─────────────────────────────┐
│  カメラ権限が必要です        │
│                             │
│  カメラを使用するには        │
│  設定から権限を許可して      │
│  ください。                  │
│                             │
│        [OK]                 │
└─────────────────────────────┘
```

### 2. 撮影エラー
```
┌─────────────────────────────┐
│  エラー                      │
│                             │
│  撮影に失敗しました。        │
│                             │
│        [OK]                 │
└─────────────────────────────┘
```

### 3. AI解析エラー
```
┌─────────────────────────────┐
│  解析エラー                  │
│                             │
│  画像解析に失敗しました。    │
│  手動で入力するか、          │
│  再撮影してください。        │
│                             │
│        [OK]                 │
└─────────────────────────────┘
```

### 4. 保存エラー
```
┌─────────────────────────────┐
│  保存エラー                  │
│                             │
│  食材の保存に失敗しました。  │
│                             │
│        [OK]                 │
└─────────────────────────────┘
```

## パフォーマンス

- 撮影: < 1秒
- AI解析（モック）: 約1秒
- 保存: < 100ms（モック）
- 画面遷移: < 100ms

## セキュリティ・プライバシー

- 一時画像: 24時間後に自動削除
- 画像送信: TLS暗号化（本番時）
- APIキー: セキュアストレージに保管（本番時）
- ユーザー同意: 利用規約で明示

## 次のステップ（本番実装）

1. Azure OpenAI API統合
2. SQLite実装
3. 実際のカメラ機能統合
4. セキュアストレージ統合
5. エラーログ収集
6. パフォーマンス最適化
